import U,{Fragment as G,createContext as W,createRef as B,useContext as V,useEffect as $,useMemo as h,useReducer as q,useRef as K}from"react";import{match as _}from'../../utils/match.js';import{forwardRefWithAs as x,render as P,Features as N}from'../../utils/render.js';import{disposables as O}from'../../utils/disposables.js';import{useDisposables as H}from'../../hooks/use-disposables.js';import{useIsoMorphicEffect as E}from'../../hooks/use-iso-morphic-effect.js';import{useSyncRefs as C}from'../../hooks/use-sync-refs.js';import{useId as F}from'../../hooks/use-id.js';import{Keys as m}from'../keyboard.js';import{Focus as R,calculateActiveIndex as J}from'../../utils/calculate-active-index.js';import{isDisabledReactIssue7711 as z}from'../../utils/bugs.js';import{isFocusableElement as X,FocusableMode as Y,sortByDomNode as Z,Focus as j,focusFrom as ee,restoreFocusIfNecessary as Q}from'../../utils/focus-management.js';import{useOutsideClick as te}from'../../hooks/use-outside-click.js';import{useTreeWalker as ne}from'../../hooks/use-tree-walker.js';import{useOpenClosed as re,State as L,OpenClosedProvider as oe}from'../../internal/open-closed.js';import{useResolveButtonType as ae}from'../../hooks/use-resolve-button-type.js';import{useOwnerDocument as ie}from'../../hooks/use-owner.js';import{useEvent as I}from'../../hooks/use-event.js';var ue=(i=>(i[i.Open=0]="Open",i[i.Closed=1]="Closed",i))(ue||{}),se=(i=>(i[i.Pointer=0]="Pointer",i[i.Other=1]="Other",i))(se||{}),le=(a=>(a[a.OpenMenu=0]="OpenMenu",a[a.CloseMenu=1]="CloseMenu",a[a.GoToItem=2]="GoToItem",a[a.Search=3]="Search",a[a.ClearSearch=4]="ClearSearch",a[a.RegisterItem=5]="RegisterItem",a[a.UnregisterItem=6]="UnregisterItem",a))(le||{});function k(t,o=i=>i){let i=t.activeItemIndex!==null?t.items[t.activeItemIndex]:null,e=Z(o(t.items.slice()),u=>u.dataRef.current.domRef.current),r=i?e.indexOf(i):null;return r===-1&&(r=null),{items:e,activeItemIndex:r}}let ce={[1](t){return t.menuState===1?t:{...t,activeItemIndex:null,menuState:1}},[0](t){return t.menuState===0?t:{...t,menuState:0}},[2]:(t,o)=>{var r;let i=k(t),e=J(o,{resolveItems:()=>i.items,resolveActiveIndex:()=>i.activeItemIndex,resolveId:u=>u.id,resolveDisabled:u=>u.dataRef.current.disabled});return{...t,...i,searchQuery:"",activeItemIndex:e,activationTrigger:(r=o.trigger)!=null?r:1}},[3]:(t,o)=>{let e=t.searchQuery!==""?0:1,r=t.searchQuery+o.value.toLowerCase(),s=(t.activeItemIndex!==null?t.items.slice(t.activeItemIndex+e).concat(t.items.slice(0,t.activeItemIndex+e)):t.items).find(c=>{var p;return((p=c.dataRef.current.textValue)==null?void 0:p.startsWith(r))&&!c.dataRef.current.disabled}),a=s?t.items.indexOf(s):-1;return a===-1||a===t.activeItemIndex?{...t,searchQuery:r}:{...t,searchQuery:r,activeItemIndex:a,activationTrigger:1}},[4](t){return t.searchQuery===""?t:{...t,searchQuery:"",searchActiveItemIndex:null}},[5]:(t,o)=>{let i=k(t,e=>[...e,{id:o.id,dataRef:o.dataRef}]);return{...t,...i}},[6]:(t,o)=>{let i=k(t,e=>{let r=e.findIndex(u=>u.id===o.id);return r!==-1&&e.splice(r,1),e});return{...t,...i,activationTrigger:1}}},w=W(null);w.displayName="MenuContext";function D(t){let o=V(w);if(o===null){let i=new Error(`<${t} /> is missing a parent <Menu /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(i,D),i}return o}function pe(t,o){return _(o.type,ce,t,o)}let de=G,me=x(function(o,i){let e=q(pe,{menuState:1,buttonRef:B(),itemsRef:B(),items:[],searchQuery:"",activeItemIndex:null,activationTrigger:1}),[r,u]=e,{itemsRef:s,buttonRef:a}=r,c=o.open!=null,p=o.open?0:1,y=c?p:r.menuState,T=C(i);const M=I(n=>{var f,d;n.type===0?(c||u(n),(f=o.onOpen)==null||f.call(o)):n.type===1?(c||u(n),(d=o.onClose)==null||d.call(o)):u(n)});te([a,s],(n,f)=>{var d;M({type:1}),X(f,Y.Loose)||(n.preventDefault(),(d=a.current)==null||d.focus())},y===0);let A=I(()=>{M({type:1})}),b=h(()=>({open:y===0,close:A}),[y,A]),l=h(()=>[{...r,menuState:y},M],[y,r,M]),g=o,v={ref:T};return U.createElement(w.Provider,{value:l},U.createElement(oe,{value:_(y,{[0]:L.Open,[1]:L.Closed})},P({ourProps:v,theirProps:g,slot:b,defaultTag:de,name:"Menu"})))}),fe="button",ye=x(function(o,i){var b;let[e,r]=D("Menu.Button"),u=C(e.buttonRef,i),s=`headlessui-menu-button-${F()}`,a=H(),c=I(l=>{switch(l.key){case m.Space:case m.Enter:case m.ArrowDown:l.preventDefault(),l.stopPropagation(),r({type:0}),a.nextFrame(()=>r({type:2,focus:R.First}));break;case m.ArrowUp:l.preventDefault(),l.stopPropagation(),r({type:0}),a.nextFrame(()=>r({type:2,focus:R.Last}));break}}),p=I(l=>{switch(l.key){case m.Space:l.preventDefault();break}}),y=I(l=>{if(z(l.currentTarget))return l.preventDefault();o.disabled||(e.menuState===0?(r({type:1}),a.nextFrame(()=>{var g;return(g=e.buttonRef.current)==null?void 0:g.focus({preventScroll:!0})})):(l.preventDefault(),r({type:0})))}),T=h(()=>({open:e.menuState===0}),[e]),M=o,A={ref:u,id:s,type:ae(o,e.buttonRef),"aria-haspopup":!0,"aria-controls":(b=e.itemsRef.current)==null?void 0:b.id,"aria-expanded":o.disabled?void 0:e.menuState===0,onKeyDown:c,onKeyUp:p,onClick:y};return P({ourProps:A,theirProps:M,slot:T,defaultTag:fe,name:"Menu.Button"})}),Te="div",Ie=N.RenderStrategy|N.Static,Me=x(function(o,i){var g,v;let[e,r]=D("Menu.Items"),u=C(e.itemsRef,i),s=ie(e.itemsRef),a=`headlessui-menu-items-${F()}`,c=H(),p=re(),y=(()=>p!==null?p===L.Open:e.menuState===0)();$(()=>{let n=e.itemsRef.current;!n||e.menuState===0&&n!==(s==null?void 0:s.activeElement)&&n.focus({preventScroll:!0})},[e.menuState,e.itemsRef,s]),ne({container:e.itemsRef.current,enabled:e.menuState===0,accept(n){return n.getAttribute("role")==="menuitem"?NodeFilter.FILTER_REJECT:n.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(n){n.setAttribute("role","none")}});let T=I(n=>{var f,d;switch(c.dispose(),n.key){case m.Space:if(e.searchQuery!=="")return n.preventDefault(),n.stopPropagation(),r({type:3,value:n.key});case m.Enter:if(n.preventDefault(),n.stopPropagation(),r({type:1}),e.activeItemIndex!==null){let{dataRef:S}=e.items[e.activeItemIndex];(d=(f=S.current)==null?void 0:f.domRef.current)==null||d.click()}Q(e.buttonRef.current);break;case m.ArrowDown:return n.preventDefault(),n.stopPropagation(),r({type:2,focus:R.Next});case m.ArrowUp:return n.preventDefault(),n.stopPropagation(),r({type:2,focus:R.Previous});case m.Home:case m.PageUp:return n.preventDefault(),n.stopPropagation(),r({type:2,focus:R.First});case m.End:case m.PageDown:return n.preventDefault(),n.stopPropagation(),r({type:2,focus:R.Last});case m.Escape:n.preventDefault(),n.stopPropagation(),r({type:1}),O().nextFrame(()=>{var S;return(S=e.buttonRef.current)==null?void 0:S.focus({preventScroll:!0})});break;case m.Tab:n.preventDefault(),n.stopPropagation(),r({type:1}),O().nextFrame(()=>{ee(e.buttonRef.current,n.shiftKey?j.Previous:j.Next)});break;default:n.key.length===1&&(r({type:3,value:n.key}),c.setTimeout(()=>r({type:4}),350));break}}),M=I(n=>{switch(n.key){case m.Space:n.preventDefault();break}}),A=h(()=>({open:e.menuState===0}),[e]),b=o,l={"aria-activedescendant":e.activeItemIndex===null||(g=e.items[e.activeItemIndex])==null?void 0:g.id,"aria-labelledby":(v=e.buttonRef.current)==null?void 0:v.id,id:a,onKeyDown:T,onKeyUp:M,role:"menu",tabIndex:0,ref:u};return P({ourProps:l,theirProps:b,slot:A,defaultTag:Te,features:Ie,visible:y,name:"Menu.Items"})}),ge=G,Re=x(function(o,i){let{disabled:e=!1,...r}=o,[u,s]=D("Menu.Item"),a=`headlessui-menu-item-${F()}`,c=u.activeItemIndex!==null?u.items[u.activeItemIndex].id===a:!1,p=K(null),y=C(i,p);E(()=>{if(u.menuState!==0||!c||u.activationTrigger===0)return;let f=O();return f.requestAnimationFrame(()=>{var d,S;(S=(d=p.current)==null?void 0:d.scrollIntoView)==null||S.call(d,{block:"nearest"})}),f.dispose},[p,c,u.menuState,u.activationTrigger,u.activeItemIndex]);let T=K({disabled:e,domRef:p});E(()=>{T.current.disabled=e},[T,e]),E(()=>{var f,d;T.current.textValue=(d=(f=p.current)==null?void 0:f.textContent)==null?void 0:d.toLowerCase()},[T,p]),E(()=>(s({type:5,id:a,dataRef:T}),()=>s({type:6,id:a})),[T,a]);let M=I(()=>{s({type:1})}),A=I(f=>{if(e)return f.preventDefault();s({type:1}),Q(u.buttonRef.current)}),b=I(()=>{if(e)return s({type:2,focus:R.Nothing});s({type:2,focus:R.Specific,id:a})}),l=I(()=>{e||c||s({type:2,focus:R.Specific,id:a,trigger:0})}),g=I(()=>{e||!c||s({type:2,focus:R.Nothing})}),v=h(()=>({active:c,disabled:e,close:M}),[c,e,M]);return P({ourProps:{id:a,ref:y,role:"menuitem",tabIndex:e===!0?void 0:-1,"aria-disabled":e===!0?!0:void 0,disabled:void 0,onClick:A,onFocus:b,onPointerMove:l,onMouseMove:l,onPointerLeave:g,onMouseLeave:g},theirProps:r,slot:v,defaultTag:ge,name:"Menu.Item"})}),qe=Object.assign(me,{Button:ye,Items:Me,Item:Re});export{qe as Menu};
